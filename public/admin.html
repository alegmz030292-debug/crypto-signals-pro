<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Crypto Signals</title>
    <style>
        body { font-family: monospace; background: #0f172a; color: white; padding: 20px; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0; }
        .stat-card { background: #1e293b; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; }
        table { width: 100%; background: #1e293b; border-radius: 10px; overflow: hidden; margin: 20px 0; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #334155; }
        .verified { color: #10b981; }
        .pending { color: #f59e0b; }
        input { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #64748b; background: #1e293b; color: white; }
        button { padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîê Panel de Administraci√≥n</h1>
    
    <div style="margin: 20px 0;">
        <input type="password" id="adminKey" placeholder="Clave de administraci√≥n">
        <button onclick="loginAdmin()">Acceder</button>
    </div>
    
    <div id="adminContent" style="display: none;">
        <!-- Estad√≠sticas -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div>Total Usuarios</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">$0</div>
                <div>Ingresos Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="vipUsers">0</div>
                <div>Usuarios VIP</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingPayments">0</div>
                <div>Pagos Pendientes</div>
            </div>
        </div>
        
        <!-- Pagos Recientes -->
        <h2>üí≥ Pagos Recientes</h2>
        <table id="paymentsTable">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Plan</th>
                    <th>Monto</th>
                    <th>Fecha</th>
                    <th>TX Hash</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="paymentsBody"></tbody>
        </table>
        
        <!-- Usuarios -->
        <h2>üë• Usuarios Registrados</h2>
        <table id="usersTable">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Email</th>
                    <th>Plan</th>
                    <th>Registro</th>
                    <th>Expira</th>
                    <th>Total Pagado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="usersBody"></tbody>
        </table>
        
        <!-- Verificar Pago Manualmente -->
        <div style="margin: 40px 0; padding: 20px; background: #1e293b; border-radius: 10px;">
            <h3>‚úÖ Verificar Pago Manualmente</h3>
            <input type="text" id="manualTxHash" placeholder="TX Hash">
            <input type="text" id="manualUsername" placeholder="Usuario">
            <select id="manualPlan">
                <option value="pro">PRO ($49)</option>
                <option value="vip">VIP ($99)</option>
            </select>
            <button onclick="verifyManualPayment()">Verificar y Actualizar</button>
        </div>
        
        <!-- Exportar Datos -->
        <button onclick="exportData()" style="background:#10b981;">üìä Exportar Datos a Excel</button>
        
        <!-- Tu Wallet -->
        <div style="margin-top: 40px; padding: 20px; background: rgba(245, 158, 11, 0.1); border-radius: 10px;">
            <h3>üí∞ Tu Wallet TRC20</h3>
            <code style="font-size: 1.2em; display: block; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                TKn8tCZKN2aSv48MGkwaLAVPodDZMtPeRV
            </code>
            <p>Balance actual: <span id="walletBalance">Consultando...</span> USDT</p>
            <button onclick="checkWalletBalance()">üîÑ Actualizar Balance</button>
        </div>
    </div>
    
    <script>
        const ADMIN_SECRET = 'tu-clave-secreta'; // CAMBIAR ESTO
        
        async function loginAdmin() {
            const key = document.getElementById('adminKey').value;
            if (key === ADMIN_SECRET) {
                document.getElementById('adminContent').style.display = 'block';
                loadAdminData();
            } else {
                alert('Clave incorrecta');
            }
        }
        
        async function loadAdminData() {
            // Cargar datos del servidor
            try {
                const response = await fetch('/.netlify/functions/admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_SECRET}`
                    },
                    body: JSON.stringify({ action: 'get_stats' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Actualizar estad√≠sticas
                    document.getElementById('totalUsers').textContent = data.stats.totalUsers;
                    document.getElementById('totalRevenue').textContent = `$${data.stats.totalRevenue}`;
                    document.getElementById('vipUsers').textContent = data.stats.vipUsers;
                    document.getElementById('pendingPayments').textContent = data.stats.pendingPayments;
                    
                    // Actualizar tablas
                    updatePaymentsTable(data.recentPayments);
                    updateUsersTable(data.recentUsers);
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                // Datos de ejemplo
                loadExampleData();
            }
        }
        
        function loadExampleData() {
            // Datos de ejemplo para testing
            const examplePayments = [
                { username: 'trader_juan', plan: 'vip', amount: 99, date: '2024-01-15 14:30', txHash: '0x123...abc', status: 'completed' },
                { username: 'crypto_maria', plan: 'pro', amount: 49, date: '2024-01-14 10:15', txHash: '0x456...def', status: 'completed' },
                { username: 'investor_pedro', plan: 'vip', amount: 99, date: '2024-01-15 16:45', txHash: null, status: 'pending' }
            ];
            
            const exampleUsers = [
                { username: 'trader_juan', email: 'juan@email.com', plan: 'vip', joined: '2024-01-01', expires: '2024-02-15', totalPaid: 99 },
                { username: 'crypto_maria', email: 'maria@email.com', plan: 'pro', joined: '2024-01-10', expires: '2024-02-14', totalPaid: 49 },
                { username: 'investor_pedro', email: 'pedro@email.com', plan: 'free', joined: '2024-01-15', expires: null, totalPaid: 0 }
            ];
            
            document.getElementById('totalUsers').textContent = exampleUsers.length;
            document.getElementById('totalRevenue').textContent = '$' + examplePayments
                .filter(p => p.status === 'completed')
                .reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('vipUsers').textContent = exampleUsers.filter(u => u.plan === 'vip').length;
            document.getElementById('pendingPayments').textContent = examplePayments.filter(p => p.status === 'pending').length;
            
            updatePaymentsTable(examplePayments);
            updateUsersTable(exampleUsers);
        }
        
        function updatePaymentsTable(payments) {
            const tbody = document.getElementById('paymentsBody');
            tbody.innerHTML = '';
            
            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.username}</td>
                    <td>${payment.plan.toUpperCase()}</td>
                    <td>$${payment.amount}</td>
                    <td>${payment.date}</td>
                    <td>${payment.txHash || 'Pendiente'}</td>
                    <td class="${payment.status === 'completed' ? 'verified' : 'pending'}">
                        ${payment.status === 'completed' ? '‚úÖ Verificado' : '‚è≥ Pendiente'}
                    </td>
                    <td>
                        ${payment.status === 'pending' ? 
                          `<button onclick="verifyPayment('${payment.id}')">Verificar</button>` : 
                          `<button onclick="resendAccess('${payment.username}')">Reenviar Acceso</button>`}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateUsersTable(users) {
            const tbody = document.getElementById('usersBody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td><span class="${user.plan}">${user.plan.toUpperCase()}</span></td>
                    <td>${user.joined}</td>
                    <td>${user.expires || 'No aplica'}</td>
                    <td>$${user.totalPaid}</td>
                    <td>
                        <button onclick="upgradeUser('${user.username}', 'pro')">Hacer PRO</button>
                        <button onclick="upgradeUser('${user.username}', 'vip')">Hacer VIP</button>
                        <button onclick="downgradeUser('${user.username}')">Hacer FREE</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function verifyManualPayment() {
            const txHash = document.getElementById('manualTxHash').value;
            const username = document.getElementById('manualUsername').value;
            const plan = document.getElementById('manualPlan').value;
            
            if (!txHash || !username) {
                alert('Completa todos los campos');
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_SECRET}`
                    },
                    body: JSON.stringify({
                        action: 'verify_payment',
                        paymentId: 'manual_' + Date.now(),
                        txHash: txHash
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Pago verificado y usuario actualizado');
                    loadAdminData();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function checkWalletBalance() {
            // Esto consultar√≠a la API de TronScan
            document.getElementById('walletBalance').textContent = 'Consultando TronScan...';
            
            // Simulaci√≥n
            setTimeout(() => {
                const balance = Math.random() * 1000 + 500;
                document.getElementById('walletBalance').textContent = balance.toFixed(2) + ' USDT';
            }, 1000);
        }
        
        function exportData() {
            // Crear CSV
            let csv = 'Usuario,Plan,Monto,Fecha,TX Hash\n';
            
            // Agregar datos de pagos
            const rows = document.querySelectorAll('#paymentsBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    csv += `"${cells[0].textContent}","${cells[1].textContent}","${cells[2].textContent}","${cells[3].textContent}","${cells[4].textContent}"\n`;
                }
            });
            
            // Descargar
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crypto_payments_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // Inicializar balance
        checkWalletBalance();
    </script>
</body>
</html>